/**
 * @author Aming
 * @name 青龙通知接口
 * @origin 红灯区
 * @version 1.0.3
 * @description 青龙通知接口
 * @public false
 * @priority 5
 * @disable false
 * @service true
 */

/* 
  说明：
    1、这是红灯区插件，基于红灯区插件进行的二开 （author Doraemon）

  ----------------------

  注意：
   1、简单测试可用
   2、无界超授可用
   3、自用插件
   4、测试阶段，还在完善。
  ----------------------

  功能：
   1、支持记录所有青龙脚本日志到本地文件，方便排查 ，文件最大10M，超过会自动清空。 （已实现）
   2、支持记录指定脚本活动未开始的日志到本地文件，方便设置定时 （已实现）
      目前支持：（后续会逐渐完善） 
          M关注抽奖 
          M等级/生日礼包 
          M幸运抽奖 
          M加购有礼 
          M无线游戏 
          M打豆豆
          M读秒手速

   3、支持匹配豆子大于等于多少豆 进行消息通知，目前只支持M部分脚本，后续完善，或者请提供日志一起完善 （已实现）
      目前支持：（后续会逐渐完善）
          M打豆豆
          M幸运抽奖
          M积分兑换
          M老虎机抽奖
          M盖楼领奖

   4、针对脚本日志有提示活动开始时间的，直接通过spy定时任务，添加定时任务 （正在完善）
   5、针对活动详情日志处理
      目前支持：（后续会逐渐完善） 
          M分享有礼：1人，2京豆 分享有豆提示
  ----------------------

  变量解释：

      notStartedPattern 未开始活动正则

      notStartedNotify 是否进行未开始活动通知

      beanNotify 是否判断京豆数量

      addCronFlag 是否进行匹配开始时间，并且添加cron

      activityInfoNotify 是否进行活动详情处理通知

  ----------------------

  更新日志：
      v1.0.0 插件上线
      2023.5.8 v1.0.1 修复插件加载异常bug
      2023.5.8 v1.0.2 新增 M积分兑换规则 / M老虎机抽奖 规则 
                      新增 京豆通知阈值
                      新增 活动详情有豆子的时候发送通知，如M分享有礼
                      新增 变量解释注释
      2923.5.9 v1.0.3 修复 未开始活动日志错误信息记录问题
                      新增 部分脚本处理 M盖楼领奖 M读秒手速
                      更新 功能注释
*/

/* 设置你的服务端token */
const setToken = '';


/* 以下是自定义配置 */
const fs = require('fs');
const Doraemon_tool = require('../自用插件/mod/Doraemon_tool');

// 需要接收通知的用户id
const notifyUserIdUserId = '5767715991';
// 发送通知的平台
const notifyPlatform = 'tgBot';
// 京豆通知阈值
const beanNotifyLimit = 5;

// 规则
const titleRegexMap = {
  'M关注抽奖': { 
    notStartedPattern: /活动未开始/, 
    notStartedNotify: true 
  },
  'M等级/生日礼包': {
    notStartedPattern: /活动还未开始哦/, 
    notStartedNotify: false 
  },
  'M幸运抽奖': { 
    notStartedPattern: /活动未开始|哎哟，当前活动尚未开始噢！|未开始/, 
    notStartedNotify: true,
    beanNotify: true,
  },
  'M加购有礼': { 
    notStartedPattern: /活动未开始/, 
    notStartedNotify: true,
    addCronFlag: true
  },
  'M无线游戏': { 
    notStartedPattern: /明日再来，还未开始/, 
  },
  'M打豆豆': { 
    beanNotify: true,
  },
  'M积分兑换': { 
    notStartedPattern: /未开始/, 
    notStartedNotify: true,
    beanNotify: true,
  },
  'M老虎机抽奖': {
    beanNotify: true,
  },
  "M分享有礼": {
    activityInfoNotify: true,
  },
  "M盖楼领奖": {
    beanNotify: true,
  },
  "M读秒手速": {
    notStartedPattern: /活动未开始/, 
  },
  // 添加更多的title和匹配规则
};


/* post接口 */
router.post('/api/qinglongMessage', (req, res) => {
    try {
        const { title, message, token } = req?.body;
        if (token !== setToken) return res.send({ code: 400, data: '', msg: '青龙BncrToken与Bncr setToken不一致' });
        /* 标题 */
        console.log('title', title);
        /* 推送日志 */
        console.log('message', message);

        // 写入所有日志
        writeLog('BncrData/public/青龙脚本日志.txt', title, message);

        // 日志处理
        handleNotStartedActivity(title, message);

        /* 返回结果 */
        return res.send({ code: 200, data: '', msg: 'ok' });
    } catch (e) {
        res.send({ code: 400, data: '', msg: '参数有误！' });
        console.error(e.toString());
    }
});


/* get接口 */
router.get('/api/qinglongMessage', async (req, res) => {
  res.send('Bncr青龙消息通知接口');
});

/** Code Encryption Block[419fd178b7a37c9eae7b7426c4a042039a719747f50834704475d1179d49a0336e100572600dfb70eced6305ba290067a980344eac103f7872183f4f2eacc1611fde84d21dda3e4929d96be01cbbc3b207e87260f22b930b1eb142f54045eb47dd3e292f3dd9f9cfe2052107322b81567dc70c87ba3b01bfd1e919d7d2e0287927a7a672f0f69aa3e1f967bef0af1ee63a3e84d2a676247959857f4c32ab314a3f5fc7068ac1573d5479e4428344cb2356c713885f35ab463ab9def04163c3c98e34c3fa1437db6276ab14a9c9c998674bf96729110530812bae6f1599b751d328b2127d09324d8de20a1c467e8a69429125ea3d9ede23d0c82ca505b8f748aded2b72adbdacebb3d980dfc4993b1cb46817a4b74a3bddb3e1827d9ed0ba7086fa7a503fb7aa6b91f5f18aaa425d5f0f14e72a94419933282c57638d7ac1edd0292e8a19c84d4d46b2d85d43dd161c22f6277275012a6b949a0ebfa15a26b2a6ae885e52841f7e9d6266f1e06ad137f172fb669fef34f340a075063818a5f0ae85e72cbe5c9089c572f32fa5d4eedc96fb855bb31563a0e961130772540961d0e9ad3ddbb0d33337a1752de9c9bdc2bb284b5c39280f9622b2a7ecf4589882dc5f90544f53ceeb9f3b499237fece074f5d55557ff297c02ab762803115001dd8e726adc997ad4789f8201214aee3903ec04e1c03ea51afd369b1f438a3acb76cc747ade19949150e7abaa2a13ea2f748d8043da44f98ea1659445ab59bf377935ba6cdd477d4e15c98d201a8b23e91558b7ff7f26c581a1dbe7ae4d1c979257674508ea6934018c91c336352f6dcb6238c916481ace3d571ded21becc8459ab8154dc1ca285e9c81ad17906e5a992579cc437b5133c83d23d2e1e28d35a2d1341cb9258e033e7527a93f50602b6294514bfa244bf0b87faf6b12dc0cd9102442ca1a36041aad75c4514bfc4948f5f9fedb71be20b4ba2bcbc9d02b6e11a4aa559528e5f5a62b4e20e3b6bbeee25cfa8b5dcde9f5c2586933ca3dc61169812fd99f6ebc0de23dfc0c247d8a13bde647b0b11dd30cd45a519ac58b7e8bcdb74667c9c6115492a8332048362c4649648f5963bbec2f6bfe29ac9649e4227eee9c891561881b26f281230b5a8b10d4bf070737ca73af23bd4fa317a14829f5f607defe23a3b62ec3fb9812bd8ea93731dd70735823a9a29946ef328c87a3c65060c2c00bcf6e7a355699e7917da517aaccc7debbfe9dc1c68e3215e6ef69a8cea344e49ab7951028e39b5f16e89d53e3dc29271dc18258dd2941ecfed9621a56dd04668f9cba8f9a04364d49ce5fe680f71501905064f666e6ad1e7f45812edcb414f46658c00e440719cc2fc80059ce1a236a6e2fc75537fa63042c7b8ee61beefed40df478ca9d6442ac81f8e9167c065a73d45f64b2a6c5b5e2a3b5e86a7913476bb17c18173a1b668400e830d244a28d54815c6bfecb23341a5595de1f490e50df127b63ec5f6cd20c0277ce03de6b179774584882d93308cb37ff103c3df6e8ff76ce13940d7ec179d88ec00c7de72bc857179327cc1a3fda168dcd261bd4ef55fa55677ca617f14f2fa75e8d34158fb876ca2dff9c640b4a33c9c436df7a401a19e249aaf5c62cffac9b4c1af031cca2ff01e3ffb770675ae0ecc6914d454fc407d645695f371dc6bf6452c3674ba82c2daa796a4f66ec06b68f2a23ffbd2d791ba975b9d5ae92e1761e6f023198f105cb0bd172a86acf682e2b9ee2096827ad27e9b88ec7ddc7863fbc075b3c0285a7810cd6bc16eee3c1e2feb3bc18af98d138aebf29cdaab25c6540c6e4a203d9a18c92882e032d90c1177538cbaf3c15ad8d4c662fea1ee0551c9cf73add4c95d927e7be30797f90657c00523bd1520c496db8adca05fba44f1f07cebee3db0b54e6cbfe01380bf71351edd1068abd5d231697b5572d34a3d5f139592662c49cf615c1e0310cf4bce8908982ea1e3680a35e3716b47bfd550e39771c7e1c36892a7c2e8df96faa75546b4664cffec82a84102321f0a2729ddbb83e243aa0dd7609b5228c4e51ed14bd6df7ebb0a6017692baba429eddc4ec6a52b62a918948a3f155cf8265adcc8b35bc2b2c65636055fb89e791f8e0e672586f443235f5687547921983e373f293e78dce3a487157aa7c7808d146470300155c9cd03d10e35e0f011af8d493cf014ccfc2e53067d575f758c863bdeb8a0894870aa03390e5574aa186358189e3e1e5a50a030f438fe9feca95755b3c01e218a4096b7fd38d770979ca1b058cbda93d00164597321b2621fe710b8f029a7f7ba56dfa0e32882cfb90860a4e043018ffdf7b01ba48d5ba84fc7da5b6f7e95f8cf5afe113527f62bf34df19dc320c4d70c4026f5621494bb4cceae1905c232a3261fae12b7babf5be177f0d36e20fcc37ace352aef8251386bba3bffadfe87c8faef973d09705b9c52fd6beb8d8320629ea0a8a45c7d3a048c253690999578ae77c63ec1444c189a77b92f946e24fa7e0c01c8c176cfcb8975b1c20009a1fe7659c5043f1a0f21e9df64fc11840f45e03c81acfc3dab1e4fc67593d7d40c077b62dbd6c32220f75e9cd69755e7f411a489008c7b6d9d1f96ed117dba355f5a28ee45e67e36d95dc4b39d006b0656501c2b82e93643af5c0336bba100e39ca392bdfd45840746176f8fcb0c2bfa1e1af0433aa219717e42c4d18c13686f35934ad5da74316b82b5486df2353cb0355da36f543d3448f57cf1128ee4e5ab3487c559f5180880234747bf82593213692fa58a975b7e3fe0ca184b3c835f83d16e1ac48def06dad4018acef435cc794fc884677b65b2a666b53bd4c0f520363581bf8d826fd25d71ccf054c3e5cbed2fae9d598aff12a6e7de42fad1794110b9ad956554a7ed1d0822320a2a9bb8c5487525dc8ba68d2fc750675505b9fc38428d4caf5fd770aad357379a918d2291a6ddf816a1a37c426d01301f556bf71e42155287d3ed7c36287fbe58fc1ed05f310ff65bba4617774bd9b05adfc4726483a4735c34b62a38d8117c02928cb4e6bd3d799cc9199b3ca81f3b0e8c62966a2ad0b6e2270e81837b5a6653f5a830efdafaa68d1a99281685440a7cdec6d8f4ed3cdeffd717f99322e9b15652c40edf66df20a224225cc396c8e848257fccb5f82f12e961ebf92833d3f36abf67ef792c2228a3221420cecc6dded6b673dd836c7114365da66988cce97f0e8fe8d4d98259c3c62575ecfdf11a4b0fda743c32ab33705b5074899ff4457686ac11ddfc40bf5ef4bf688fd733cfa804979b6999887e6c5f96b4f3969821157735cb783ea03401d1fe59624a1c8f890dfa0481dec0389d362eba5c0d8eff41c6507d9af79ddea63304188733cd96ba727781d7dc3028fd151b49f9a3eca1028795b33aff46a3d83604814f3776f4412a2dc30072da9938e5edbd320a96aa2ad2654b1c2739993ea04f956bf0a8eebc1eeb97868ab0165bbe29e1f5e9553686df9d7d8424603ca18a744cb8f81eb871aa2378caca29e531165bf5eba1d99f520b871a1d77389600e2c5ea04b3d96aa97dc42fe02bf621d823d77aacb4245299385a01a44e4ef1fac2c802fba5e6bf0f7141ec209f41b71e6cd3c702f7b23c80ea528388fc8e1b02db3d656b714d18ab24f99ec686f9528e3cfe8bff6bd1d6cb42cb0cb71455f7fb5b04624f5f993b3b4e6ff6add0e208107edf96ec39b8301b943ab8d31a5af89a05787a51e41cb337512210d9b205d3ed89c97ce822862739707ffc26f3244d68194b91ef96d8888afb150aed69fd218247db71e3f1a261eafa5341d36d9adec77b495db26fedeab7d1245bd5a81077302022eb6bfdb75a610781ac12600a390e2e753cf5240e80add06ad8b2c087bb15ee0ecbd78038844f2f6d7fc173692d82461f403491ffbbc43b8d1332adfd88abaf8120a703ad0c1c69da8628ae89cb4642ea026b0dbcda09e184ae266edd5487088ffb4191ab6361f42b6d6296f4035727f7f3d2e564e4211506b597f0783a871152d6977897663977f21b5c643658435124294468f20e922b2b1b418be5795b9b63fc6ae94d8050c7259660bc80b83b7c800a52a25b49820a738f28d57b18ea782ddaeee31fa002a08cbe2bb66010115ab705f0f27a3d0ff2e81017035d8f62ee44335984d67bbef2bb3c9cb941e48c580b91407cb527f85b0f86291e4691935ac5db46980285431021e6ea1ba2673f1f868e10f69c821fa1a2a3bd0df53f0afedb2a51877c8bb75bbecdc60ebbd425d5d3bdd66049b9bb3a868715e93350a0b6ce54bc05108c728aa00d5ee294c9cd368dd5eefc19c800bb1ee2b5d342147c7ebadc1ac28a53b4e36b3e0a5cbd251a3e926225e66ee7350f0c2a0d663a56fa34688e7e3464b443945753b8f938e0724aeaeb13f31525af2c2a1f52370632873ca01f40df1335416232eefb09f40e77e665d249d79d348fa57df75fd5226cc3205d5a460d2dd8f925a72f4eedf5752e3495bba6d537c4a5873b8b985622809d64ec3da0cacbac563e1071207c2c5c1f175de567c721bdc56e038f3241850999b5573de5ddb2658531fa3563c7e597e266c5a6678c00cfd2cd016edf8365d6df83f414ea84139af1c3c7f7f5189a21fd8bf8165a29e7feb5b4bbcf0695dc1f2ed58120b59cc546b02ce0298a11c28656a6b7eba8aa854a7005be71d2a71b8bbc6f2dbca0a9a4201f6c5d0033b0c1aecdd8c430b316fdc2b53c40dec5218cfc24fa6ea34954c9752024dda92e21d6466a21b0096a60c720ebf645ece7e325c0a82be344e4fed1df0f0be9868575ea0ad2d7b7c4e3edce048157d29bee0e5a4fdf3d2a1f239e7815296509a1619469b16869db4d54557655258dde33466196a3f83724802e6a0560f62e69a8cf40f11338411642dcdc519959617f0d57d50176e48344649ad208c0e839e64b299e24903ab1d9fdd23760858fa0642b7b684bf431fe39aebbe06d453f621590da20cbbdc86f1dc2beb5832b0355b5a2d7be795fd466ef3cc8e512fb07bf4e4243b3ea5d1043085b5a50195aec31383bd6daa2dc6e2343ea5ae2b6a72607ba8e8cf9b39dc48fc68a7d8baef75a664e82c69b896a43e1d10227f66fa659018bc20a6c83c4e849fcb3a8676e42a42a832f687bf3c981a5f5056c5d6808f95cd6215fddf01b73f9998073fec707d5c06dfdd689495bedb51a9f9fe37284245aab6dafea43d4757ad02d3475ba0e5039d1eeb3c23b924bdbecd85ce33f96dc1f170da5425e2e8ab6df774b299c261f89aacf5d9e98a8205b71d5bd3333992ad1d28e6ad8b3736ddb1792a4df6c8ab43dc7d288a847972eb27fab8c8afab4ef8498611b9fd2cceee3193986877b1254a821b7524ecb3d8372437bad134c5794624b4f75c4ee902e85a36a8ed9d9a8babb93eb88ab782650a82032ab60f0f26a9ebcdf046ca18dcc91646a035a082b7fc8b6e85e207a7bf4871f0c741d24244631c9c88a47b6455cb73de2fdadaa53069e2980c9819658281be38be60eb2d3b385ee33317278334baa230b8de31e621219cadf0e0eb01a09f4703af37ad7109b79b570f3ee062b2bf5286aead6ded841a7731517e0535a9ba92020f839e186a74edf23b128609c26c33953295bad475758a19525c17eb38e6c6a93c8f8842d081c1f798c72247c60033e0941de930987b6fcc63347c1e9cd117a60ff1cfe56daa104205e562bca08558888aa9463ffdc282c208f66f22f3a281c6863dd0b8c552b2815a05b4e727f7e7c34f1862d552b87025e7da12ce6645be0e06e20bc6cade8557b6ae67a1485d4941100cecb39f39621a1ccdec9ac1fb91f5daf17c3485558dfc8508e3184af2080eb2aff21c0a7ee2f06c46cd1531cd961496a831f37a74fa83857b830ed5a4fd5bf150d5b63ca734e6a85e985d52a62b45dbc8fb1870d9e0a3315812d335f7732650054ec784c48266130a1dadffb5b08a9de4b449b29842639aad964a3594d003b8202a8955e58b0547b601bbd72c766f1b381967a5637e9b2281247326f58368dc711b224ac293b4e0e5f7645fe9ccec7e703fe940cdf8981f1026fcb7c747a0b1ef7c70409ca026e6f88ca06b094238210206ba91] */